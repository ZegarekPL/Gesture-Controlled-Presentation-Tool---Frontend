name: Docker Release Workflow

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Get the Git tag
        id: get_tag
        run: |
          TAG="${GITHUB_REF##*/}"
          echo "Tag is: $TAG"
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Build Docker image using Docker Compose
        run: |
          # Dynamically set the tag for the image
          docker-compose -f docker-compose.yml build --no-cache

      - name: Tag Docker image with Git tag
        run: |
          docker tag gesture_controlled_presentation_tool_frontend:latest gesture_controlled_presentation_tool_frontend:${{ env.TAG }}

      - name: Save Docker image as tar
        run: |
          docker save -o gesture_controlled_presentation_tool_frontend-${{ env.TAG }}.tar gesture_controlled_presentation_tool_frontend:${{ env.TAG }}

      - name: Zip Docker image
        run: |
          zip gesture_controlled_presentation_tool_frontend-${{ env.TAG }}.zip gesture_controlled_presentation_tool_frontend-${{ env.TAG }}.tar

      - name: Create GitHub Release and upload zip
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          files: gesture_controlled_presentation_tool_frontend-${{ env.TAG }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up
        run: |
          rm gesture_controlled_presentation_tool_frontend-${{ env.TAG }}.tar
          rm gesture_controlled_presentation_tool_frontend-${{ env.TAG }}.zip
